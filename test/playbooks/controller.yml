---
- hosts: controller*
  become: yes
  become_method: sudo
  vars:
    username: "buildbot"
    inventory_filepath: "/etc/stackforce/inventory"
    unique_containers_file: "/etc/stackforce/containers.yml"
  tasks:
    - name: add user
      user: name="{{ username }}" shell=/bin/bash groups=wheel
    - name: sudoers
      command: sed --in-place 's/^#\s*\(%wheel\s\+ALL=(ALL)\s\+NOPASSWD:\s\+ALL\)/\1/' /etc/sudoers
    - authorized_key:
        user: "{{ username }}"
        key:  "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
    - name: Custom ssh config
      become_user: "{{ username }}"
      copy: src="files/dot_ssh/config" dest="~/.ssh/config" mode=600 owner="{{ username }}"
    - name: private ssh key
      copy:
        src: "~/.ssh/id_rsa"
        dest: "/home/{{ username }}/.ssh/id_rsa"
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: "600"
    - name: public ssh key
      copy:
        src: "~/.ssh/id_rsa.pub"
        dest: "/home/{{ username }}/.ssh/id_rsa.pub"
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: "644"
    - name: Install repos
      yum: name="{{ item }}" state=present
      with_items:
        - epel-release
    - name: Upgrade all packages
      yum: name=* state=latest
    - name: Install necessary packages
      yum:
        name: "{{ item }}"
        state: latest
      with_items:
        - "http://repo.cloudlinux.com/stackforce-staging/x86_64/python2-lxc-0.1-1.git0553f05.el7.x86_64.rpm"
        - git
        - python-devel
        - gcc
        - python-pip
    - pip: name=ansible

    - git:
        repo: "git@bitbucket.org:stackforce/stackforce-ansible.git"
        dest: "/home/{{ username }}/stackforce-ansible"
        recursive: yes
        accept_hostkey: yes
        key_file: "/home/{{ username }}/.ssh/id_rsa"
      become_user: "{{ username }}"

    - name: Create config dir
      file: path=/etc/stackforce state=directory
    - name: Set parameters.ini
      template: src=parameters.ini.j2 dest=/etc/stackforce/parameters.ini
    - name: Set containers.yml
      copy: src=files/tst_two.yml dest=/etc/stackforce/containers.yml
    - name: Set vagrant inventory
      copy: src=tst_two dest=/etc/stackforce/inventory
