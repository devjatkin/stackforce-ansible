---
- hosts: controller*
  become: yes
  become_method: sudo
  vars:
    username: "buildbot"
  tasks:
    - name: add user
      user: name="{{ username }}" shell=/bin/bash groups=wheel
    - name: sudoers
      command: sed --in-place 's/^#\s*\(%wheel\s\+ALL=(ALL)\s\+NOPASSWD:\s\+ALL\)/\1/' /etc/sudoers
    - authorized_key:
        user: "{{ username }}"
        key:  "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
    - name: Custom ssh config
      become_user: "{{ username }}"
      copy: src="files/dot_ssh/config" dest="~/.ssh/config" mode=600 owner="{{ username }}"
    - name: private ssh key
      copy:
        src: "~/.ssh/id_rsa"
        dest: "/home/{{ username }}/.ssh/id_rsa"
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: "600"
    - name: public ssh key
      copy:
        src: "~/.ssh/id_rsa.pub"
        dest: "/home/{{ username }}/.ssh/id_rsa.pub"
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: "644"
    - yum:
        name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm"
    - yum:
        name: "{{ item }}"
        state: present
      with_items:
        - git
        - python-devel
        - gcc
        - python-pip
        - python-nose
        - python-ipython
        - ansible-lint
    - pip: name=ansible

    - git:
        repo: "git@bitbucket.org:stackforce/stackforce-ansible.git"
        dest: "/home/{{ username }}/stackforce-ansible"
        recursive: yes
        accept_hostkey: yes
        key_file: "/home/{{ username }}/.ssh/id_rsa"
      become_user: "{{ username }}"
